---
# HTTPRoute for demonstrating load balancing between services
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: load-balancing-route
  namespace: default
  labels:
    app.kubernetes.io/name: load-balancer
    app.kubernetes.io/component: route
    purpose: demo-load-balancing
  annotations:
    description: "Demonstrates load balancing between Service A and Service B"
spec:
  parentRefs:
  - name: demo-gateway
    namespace: default
  hostnames:
  - "demo.local"
  - "lb.demo.local"
  rules:
  # Rule 1: Root path load balancing (50/50 split)
  - matches:
    - path:
        type: Exact
        value: /
    filters:
    - type: ResponseHeaderModifier
      responseHeaderModifier:
        add:
        - name: X-Load-Balanced
          value: "true"
        - name: X-Gateway
          value: "Envoy"
    backendRefs:
    - name: service-a
      port: 8080
      weight: 50
    - name: service-b
      port: 8080
      weight: 50
  # Rule 2: Weighted load balancing (70/30 split)
  - matches:
    - path:
        type: PathPrefix
        value: /weighted
    filters:
    - type: ResponseHeaderModifier
      responseHeaderModifier:
        add:
        - name: X-Weight-Distribution
          value: "70-30"
    backendRefs:
    - name: service-a
      port: 8080
      weight: 70
    - name: service-b
      port: 8080
      weight: 30
  # Rule 3: Canary deployment simulation (90/10 split)
  - matches:
    - path:
        type: PathPrefix
        value: /canary
    filters:
    - type: ResponseHeaderModifier
      responseHeaderModifier:
        add:
        - name: X-Deployment-Type
          value: "canary"
    backendRefs:
    - name: service-a
      port: 8080
      weight: 90
    - name: service-b
      port: 8080
      weight: 10