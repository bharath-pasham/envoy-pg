# VirtualServices for service-a and service-b providing weighted & header-based routing
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: service-a
  namespace: default
spec:
  hosts:
  - "demo.local"
  - "service-a.demo.local"
  gateways:
  - istio-demo-gateway  # Gateway (same namespace) â€“ corrected reference format
  http:
  - name: service-a-canary-header
    match:
    - uri:
        prefix: /api/service-a
      headers:
        X-Canary:
          exact: "true"
    - uri:
        exact: /service-a
      headers:
        X-Canary:
          exact: "true"
    retries: { attempts: 0 }
    route:
    - destination:
        host: service-a-canary.default.svc.cluster.local
        port: { number: 8080 }
      weight: 100
    headers:
      request:
        add:
          X-Service: service-a
      response:
        add:
          X-Version: canary
          X-Pod-Type: v2
  - name: service-a-weighted
    match:
    - uri:
        prefix: /api/service-a
    - uri:
        exact: /service-a
    timeout: 30s
    retries:
      attempts: 3
      perTryTimeout: 10s
      retryOn: "retriable-status-codes,connect-failure,reset"
    route:
    - destination:
        host: service-a.default.svc.cluster.local
        port: { number: 8080 }
      weight: 80
    - destination:
        host: service-a-canary.default.svc.cluster.local
        port: { number: 8080 }
      weight: 20
    headers:
      request:
        add:
          X-Service: service-a
      response:
        add:
          X-Version: weighted
  - name: service-a-health
    match:
    - uri:
        prefix: /health/service-a
    rewrite:
      uri: /health
    route:
    - destination:
        host: service-a.default.svc.cluster.local
        port: { number: 8080 }
---
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: service-b
  namespace: default
spec:
  hosts:
  - "demo.local"
  - "service-b.demo.local"
  gateways:
  - istio-demo-gateway  # Corrected reference
  http:
  - match:
    - uri:
        prefix: /api/service-b
    - uri:
        exact: /service-b
    timeout: 60s
    retries:
      attempts: 2
      perTryTimeout: 20s
      retryOn: "retriable-status-codes,connect-failure,reset"
    route:
    - destination:
        host: service-b.default.svc.cluster.local
        port: { number: 8080 }
    headers:
      request:
        add:
          X-Service: service-b
